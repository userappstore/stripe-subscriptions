
> @userappstore/stripe-subscriptions@1.0.1036 test /home/ubuntu/workspace
> NODE_ENV=testing mocha src/www/api/user --recursive --timeout 1800000 --slow 1



  /api/user/subscriptions/card-charges-count
    CardChargesCount#GET
      ✓ should count all charges on card (22406ms)

  /api/user/subscriptions/card-charges
    CardCharges#GET
      ✓ should limit card's charges to one page (31570ms)
      ✓ should enforce page size (48044ms)
      ✓ should enforce specified offset (40399ms)

  /api/user/subscriptions/card-invoices-count
    CardInvoicesCount#GET
      ✓ should count all invoices on card (18334ms)

  /api/user/subscriptions/card-invoices
    CardInvoices#GET
      ✓ should limit invoices on card to one page (31919ms)

  /api/user/subscriptions/card-refunds-count
    CardRefundsCount#GET
      ✓ should count all refunds on card (50420ms)

  /api/user/subscriptions/card-refunds
    CardRefunds#GET
      ✓ should limit refunds on card to one page (56279ms)

  /api/user/subscriptions/card-subscriptions-count
    CardSubscriptionsCount#GET
      ✓ should count all subscriptions on card (30830ms)

  /api/user/subscriptions/card-subscriptions
    CardSubscriptions#GET
      ✓ should limit subscriptions on card to one page (29751ms)

  /api/user/subscriptions/card
    Card#GET
      ✓ should reject invalid card (1909ms)
      ✓ should reject other account's card (5186ms)
      ✓ should return card data (3478ms)

  /api/user/subscriptions/cards-count
    CardsCount#GET
      ✓ should count account's cards (6224ms)

  /api/user/subscriptions/cards
    Cards#GET
      ✓ should limit cards to one page (6612ms)
      ✓ should enforce page size (8512ms)
      ✓ should enforce specified offset (7859ms)

  /api/user/subscriptions/charge
    Charge#GET
      ✓ should reject invalid charge (1610ms)
      ✓ should reject other account's charge (23872ms)
      ✓ should return charge data (22036ms)

  /api/user/subscriptions/charges-count
    Charges#GET
      ✓ should count charges (42044ms)

  /api/user/subscriptions/charges
    Charges#GET
      ✓ should limit charges to one page (32155ms)

  /api/user/subscriptions/create-card
    CreateCard#POST
      ✓ should require name, cvc, number, exp_month and exp_year (1959ms)
      ✓ should create card (3440ms)

  /api/user/subscriptions/create-customer
    CreateCustomer#POST
      ✓ should reject other accountid (3254ms)
      ✓ should reject existing customer (2255ms)
      ✓ should create customer (1929ms)

  /api/user/subscriptions/create-refund
    CreateRefund#POST
      ✓ should reject invalid charge (1620ms)
      ✓ should reject other account's charge (21584ms)
      ✓ should create refund (18716ms)

  /api/user/subscriptions/create-subscription
    CreateSubscription#POST
      ✓ should reject invalid planid (3525ms)
      ✓ should reject never-published planid (7139ms)
      ✓ should reject unpublished plan (8018ms)
      ✓ should allow customer without card on free plan (6770ms)
      ✓ should reject customer without card (5826ms)
      ✓ should create authorized subscription (8450ms)

  /api/user/subscriptions/customer
    Customer#GET
      ✓ should reject invalid customerid (2511ms)
      ✓ should reject other account's customerid (5886ms)
      ✓ should return customer data (3463ms)

  /api/user/subscriptions/delete-card
    DeleteCard#DELETE
      ✓ should reject invalid cardid (1664ms)
      ✓ should reject other account's card (6699ms)
      ✓ should delete card (4258ms)

  /api/user/subscriptions/delete-subscription
    DeleteSubscription#DELETE
      ✓ should reject invalid subscriptionid (1665ms)
      ✓ should reject other account's subscription (16568ms)
      ✓ should require active subscription (15410ms)
      ✓ should delete subscription at period end (15288ms)
      ✓ should delete subscription immediately (14081ms)

  /api/user/subscriptions/invoice
    Invoice#GET
      ✓ should reject invalid invoice (1662ms)
      ✓ should reject other account's invoice (22189ms)
      ✓ should return invoice data (23124ms)

  /api/user/subscriptions/charges-count
    InvoicesCount#GET
      ✓ should count charges (34777ms)

  /api/user/subscriptions/invoices
    Invoices#GET
      ✓ should limit invoices to one page (42340ms)

  /api/user/subscriptions/plan-cards-count
    PlanCardsCount#GET
      ✓ should count all cards on plan (45958ms)

  /api/user/subscriptions/plan-cards
    PlanCards#GET
      ✓ should limit cards to one page (44985ms)
      ✓ should enforce page size (94054ms)
      ✓ should enforce specified offset (54589ms)

  /api/user/subscriptions/plan-charges-count
    PlanChargesCount#GET
      ✓ should count all charges on plan (62271ms)

  /api/user/subscriptions/plan-charges
    PlanCharges#GET
      ✓ should limit charges to one page (48830ms)
      ✓ should enforce page size (52506ms)
      ✓ should enforce specified offset (53395ms)

  /api/user/subscriptions/plan-invoices-count
    PlanInvoicesCount#GET
      ✓ should count all invoices on plan (35975ms)

  /api/user/subscriptions/plan-invoices
    PlanInvoices#GET
      ✓ should limit invoices to one page (45717ms)
      ✓ should enforce page size (65906ms)
      ✓ should enforce specified offset (57733ms)

  /api/user/subscriptions/plan-subscriptions-count
    PlanSubscriptionsCount#GET
      ✓ should count all subscriptions on plan (37042ms)

  /api/user/subscriptions/plan-subscriptions
    PlanSubscriptions#GET
      ✓ should limit subscriptions to one page (42606ms)
      ✓ should enforce page size (53529ms)
      ✓ should enforce specified offset (57447ms)

  /api/user/subscriptions/product-cards-count
    ProductCardsCount#GET
      ✓ should count all cards on product (43210ms)

  /api/user/subscriptions/product-cards
    ProductCards#GET
      ✓ should limit cards to one page (66938ms)
      ✓ should enforce page size (53210ms)
      ✓ should enforce specified offset (64956ms)

  /api/user/subscriptions/product-charges-count
    ProductChargesCount#GET
      ✓ should count all charges on product (41289ms)

  /api/user/subscriptions/product-charges
    ProductCharges#GET
      ✓ should limit charges to one page (41651ms)
      ✓ should enforce page size (54243ms)
      ✓ should enforce specified offset (45635ms)

  /api/user/subscriptions/product-invoices-count
    ProductInvoicesCount#GET
      ✓ should count all invoices on product (38069ms)

  /api/user/subscriptions/product-invoices
    ProductInvoices#GET
      ✓ should limit invoices to one page (36913ms)
      ✓ should enforce page size (62541ms)
      ✓ should enforce specified offset (48375ms)

  /api/user/subscriptions/product-subscriptions-count
    ProductSubscriptionsCount#GET
      ✓ should count all subscriptions on product (39109ms)

  /api/user/subscriptions/product-subscriptions
    ProductSubscriptions#GET
      ✓ should limit subscriptions to one page (53696ms)
      ✓ should enforce page size (47798ms)
      ✓ should enforce specified offset (48408ms)

  /api/user/subscriptions/published-plan
    PublishedPlan#GET
      ✓ should not require account (7403ms)
      ✓ should reject never published plan (11726ms)
      ✓ should reject unpublished plan (13171ms)
      ✓ should return plan data (11575ms)

  /api/user/subscriptions/published-plans-count
    PublishedPlansCount#GET
      ✓ should count published plans (13895ms)

  /api/user/subscriptions/published-plans
    PublishedPlans#GET
      ✓ should not require account (7421ms)
      ✓ should exclude never published plans (9477ms)
      ✓ should exclude unpublished plan (15446ms)
      ✓ should return plan list (17382ms)

  /api/user/subscriptions/published-product
    PublishedProduct#GET
      ✓ should not require account (9631ms)
      ✓ should reject never published product (9544ms)
      ✓ should reject unpublished product (11190ms)
      ✓ should return product data (9618ms)

  /api/user/subscriptions/published-products-count
    PublishedProductsCount#GET
      ✓ should count published products (10773ms)

  /api/user/subscriptions/published-products
    PublishedProducts#GET
      ✓ should not require account (10288ms)
      ✓ should exclude never published products (11018ms)
      ✓ should exclude unpublished product (12793ms)
      ✓ should limit product list to one page (13839ms)

  /api/user/subscriptions/refund
    Refund#GET
      ✓ should reject invalid refund (4399ms)
      ✓ should reject other account's refund (39981ms)
      ✓ should return refund data (38285ms)

  /api/user/subscriptions/refunds-count
    RefundsCount#GET
      ✓ should count refunds (52014ms)

  /api/user/subscriptions/refunds
    Refunds#GET
      ✓ should limit refunds to one page (73700ms)
      ✓ should enforce page size (93953ms)
      1) should enforce specified offset

  /api/user/subscriptions/set-customer-coupon
    SetCustomerCoupon#PATCH
      ✓ should reject invalid customerid (11773ms)
      ✓ should reject account with coupon (12950ms)
      ✓ should apply coupon (11314ms)

  /api/user/subscriptions/set-invoice-paid
    SetInvoicePaid#PATCH
      ✓ should reject invalid invoiceid (6280ms)
      ✓ should reject other account's invoice (36644ms)
      ✓ should reject paid invoice (29685ms)
      ✓ should reject forgiven invoice (29347ms)
      ✓ should reject invalid source (26440ms)
      ✓ should reject other account's source (30719ms)
      ✓ should pay invoice (28844ms)

  /api/user/subscriptions/set-subscription-coupon
    SetSubscriptionCoupon#PATCH
      ✓ should reject invalid subscriptionid (11860ms)
      ✓ should reject subscription with coupon (27462ms)
      ✓ should apply coupon (24663ms)

  /api/user/subscriptions/set-subscription-plan
    SetSubscriptionPlan#PATCH
      ✓ should reject invalid subscriptionid (4100ms)
      ✓ should reject other account's subscription (36695ms)
      ✓ should reject same planid (19834ms)
      ✓ should require user add card (16122ms)
      ✓ should change plan (23322ms)

  /api/user/subscriptions/subscription-cards-count
    SubscriptionCardsCount#GET
      ✓ should count all cards on subscriptions (38941ms)

  /api/user/subscriptions/subscription-cards
    SubscriptionCards#GET
      ✓ should limit cards to one page (54517ms)
      ✓ should enforce page size (63501ms)
      ✓ should enforce specified offset (64251ms)

  /api/user/subscriptions/subscription-charges-count
    SubscriptionChargesCount#GET
      ✓ should count all charges on subscription (39060ms)

  /api/user/subscriptions/subscription-charges
    SubscriptionCharges#GET
      ✓ should limit charges on subscription to one page (40804ms)

  /api/user/subscriptions/subscription-invoices-count
    SubscriptionInvoicesCount#GET
      ✓ should count subscription's invoices (47260ms)

  /api/user/subscriptions/subscription-invoices
    SubscriptionInvoices#GET
      ✓ should limit invoices on subscription to one page (49489ms)

  /api/user/subscriptions/subscription-refunds-count
    SubscriptionRefundsCount#GET
      ✓ should count all refunds on subscription (64082ms)

  /api/user/subscriptions/subscription-refunds
    SubscriptionRefunds#GET
      ✓ should limit refunds on subscription to one page (61065ms)

  /api/user/subscriptions/subscription
    Subscription#GET
      ✓ should reject invalid subscriptionid (3901ms)
      ✓ should reject other account's subscription (25398ms)
      ✓ should return subscription data (16765ms)

  /api/user/subscriptions/subscriptions-count
    SubscriptionsCount#GET
      ✓ should count published subscriptions (23338ms)

  /api/user/subscriptions/subscriptions
    Subscriptions#GET
      ✓ should return subscription list (21489ms)

  /api/user/subscriptions/upcoming-invoice
    Upcominginvoice#GET
      ✓ should reject invalid subscriptionid (3980ms)
      ✓ should reject other account's subscription (32054ms)
      ✓ should return upcoming invoice for subscription (21333ms)

  /api/user/subscriptions/upcoming-invoices-count
    UpcominginvoicesCount#GET
      ✓ should count upcoming invoices (27957ms)

  /api/user/subscriptions/upcoming-invoices
    UpcomingInvoices#GET
      ✓ should return upcoming invoice for each subscription (21746ms)


  146 passing (1h)
  1 failing

  1) /api/user/subscriptions/refunds
       Refunds#GET
         should enforce specified offset:

      AssertionError [ERR_ASSERTION]: 're_1CkDEiJJXlWQOaGKrem23Whj' == 're_1CkDEsJJXlWQOaGKGMLXdCjm'
      + expected - actual

      -re_1CkDEiJJXlWQOaGKrem23Whj
      +re_1CkDEsJJXlWQOaGKGMLXdCjm
      
      at it (src/www/api/user/subscriptions/refunds.test.js:105:16)
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:169:7)



