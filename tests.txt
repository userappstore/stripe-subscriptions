
> @userappstore/stripe-subscriptions@1.0.1058 test /root/workspace/stripe-subscriptions
> NODE_ENV=testing mocha --recursive --timeout 180000 --slow 1 "src"



  proxy/x-customer-header
    Customer#AFTER
     # 1
      ✓ should set customer data in header (2221ms)

  proxy/x-invoices-header
    Invoices#AFTER
     # 2
      ✓ should set invoice data in header (13011ms)

  proxy/x-subscriptions-header
    Subscriptions#AFTER
     # 3
      ✓ should set invoice data in header (14228ms)

  server/bind-customer
    BindCustomer#AFTER
     # 4
      ✓ should bind existing customer data to req (2323ms)

  server/bind-stripekey
    BindStripeKey#AFTER
     # 5
      ✓ should bind stripekey data to req (1622ms)

  server/require-payment
    RequirePayment#AFTER
     # 6
      ✓ should allow non-customer through (1615ms)
     # 7
      ✓ should allow unsubscribed customer through (2136ms)
     # 8
      ✓ should allow owing customer access to /account/* (20609ms)
     # 9
      ✓ should allow owing administrator access to /administrator/ (16246ms)
     # 10
      ✓ should redirect owing customer (21419ms)
     # 11
      ✓ should allow non-owing customer (16547ms)

  server/require-subscription
    RequireSubscription#AFTER
     # 12
      ✓ should allow non-customer (1854ms)
     # 13
      ✓ should allow customer without subscription access to /account/* (2236ms)
     # 14
      ✓ should allow administrator without subscription access to /administrator/ (3531ms)
     # 15
      ✓ should redirect unsubscribed customer to the plans list (1974ms)
     # 16
      ✓ should allow customer with subscription to pass (15010ms)

  /account/subscriptions/cancel-subscription
    CancelSubscription#BEFORE
     # 17
      ✓ should bind subscription to req (26872ms)
    CancelSubscription#GET
     # 18
      ✓ should present the form (11961ms)
     # 19
      ✓ should present the subscription table (13980ms)
    CancelSubscription#POST
     # 20
      ✓ should apply after authorization (17539ms)

  /account/subscriptions/card
    Card#BEFORE
     # 21
      ✓ should reject invalid card (2006ms)
     # 22
      ✓ should reject other account's card (5790ms)
     # 23
      ✓ should bind card to req (4099ms)
    Card#GET
     # 24
      ✓ should have row for card (4001ms)

  /account/subscriptions/cards
    Cards#BEFORE
     # 25
      ✓ should bind cards to req (8039ms)
    Cards#GET
     # 26
      ✓ should enforce page size (9759ms)
     # 27
      ✓ should enforce specified offset (9237ms)

  /account/subscriptions/change-plan
    ChangePlan#BEFORE
     # 28
      ✓ should bind subscription to req (24099ms)
    ChangePlan#GET
     # 29
      ✓ should present the form (14973ms)
     # 30
      ✓ should present the subscription table (15613ms)
    ChangePlan#POST
     # 31
      ✓ should reject same plan (15612ms)
     # 32
      ✓ should reject never published plan (18525ms)
     # 33
      ✓ should reject unpublished plan (18211ms)
     # 34
      ✓ should reject paid plan without payment information (15857ms)
     # 35
      ✓ should apply after authorization (19090ms)

  /account/subscriptions/delete-card
    DeleteCard#BEFORE
     # 36
      ✓ should reject invalid cardid (5907ms)
     # 37
      ✓ should reject other account's card (9507ms)
     # 38
      ✓ should reject default payment source (8137ms)
     # 39
      ✓ should bind card to req (5349ms)
    DeleteCard#GET
     # 40
      ✓ should present the form (7184ms)
     # 41
      ✓ should present the card table (5562ms)
    DeleteCard#POST
     # 42
      ✓ should apply after authorization (6738ms)

  /account/subscriptions/edit-payment-information
    EditPaymentInformation#GET
     # 43
      ✓ should present the form (2309ms)
    EditPaymentInformation#POST
     # 44
      ✓ should require name (2257ms)
     # 45
      ✓ should require CVC (2339ms)
     # 46
      ✓ should require card number (2181ms)
     # 47
      ✓ should require expiration month (2189ms)
     # 48
      ✓ should require expiration year (2237ms)
     # 49
      ✓ should apply after authorization (4145ms)

  /account/subscriptions
    Index#BEFORE
     # 50
      ✓ should bind cards to req (4160ms)
     # 51
      ✓ should bind invoices to req (14490ms)
     # 52
      ✓ should bind subscriptions to req (16824ms)
    Index#GET
     # 53
      ✓ should have row for each invoice (26867ms)
     # 54
      ✓ should have row for each card (5983ms)
     # 55
      ✓ should have row for each subscription (26801ms)

  /account/subscriptions/invoice
    Invoice#BEFORE
     # 56
      ✓ should reject invalid invoice (3548ms)
     # 57
      ✓ should reject other account's invoice (15928ms)
     # 58
      ✓ should bind invoice to req (21845ms)
    Invoice#GET
     # 59
      ✓ should have row for invoice (20246ms)

  /account/subscriptions/invoices
    Invoices#BEFORE
     # 60
      ✓ should bind invoices to req (33326ms)
    Invoices#GET
     # 61
      ✓ should enforce page size (45421ms)
     # 62
      ✓ should enforce specified offset (42198ms)

  /account/subscriptions/pay-invoice
    PayInvoice#BEFORE
     # 63
      ✓ should reject invalid invoice (1971ms)
     # 64
      ✓ should reject other account's invoice (27702ms)
     # 65
      ✓ should reject paid invoice (16753ms)
     # 66
      ✓ should bind invoice to req (17973ms)
    PayInvoice#GET
     # 67
      ✓ should present the form (20229ms)
     # 68
      ✓ should present the invoice table (19142ms)
    PayInvoice#POST
     # 69
      ✓ should apply after authorization (28057ms)

  /account/subscriptions/plan
    Plan#BEFORE
     # 70
      ✓ should reject invalid plan (2478ms)
     # 71
      ✓ should reject never published plan (6210ms)
     # 72
      ✓ should reject unpublished plan (7505ms)
     # 73
      ✓ should bind plan to req (6250ms)
    Plan#GET
     # 74
      ✓ should have row for plan (6214ms)

  /account/subscriptions/plans
    Plans#BEFORE
     # 75
      ✓ should bind plans to req (9355ms)
    Plans#GET
     # 76
      ✓ should enforce page size (11359ms)
     # 77
      ✓ should enforce specified offset (11430ms)

  /account/subscriptions/refund-invoice
    RefundInvoice#BEFORE
     # 78
      ✓ should reject invalid invoice (3468ms)
     # 79
      ✓ should reject other account's invoice (16302ms)
     # 80
      ✓ should bind invoice to req (17019ms)
     # 81
      ✓ should bind charge to req (15830ms)
    RefundInvoice#GET
     # 82
      ✓ should present the form (15627ms)
     # 83
      ✓ should present the invoice table (15817ms)
    RefundInvoice#PATCH
     # 84
      ✓ should apply after authorization (19085ms)

  /account/subscriptions/start-subscription
    StartSubscription#BEFORE
     # 85
      ✓ should reject invalid plan (1925ms)
     # 86
      ✓ should reject never published plan (7652ms)
     # 87
      1) should reject unpublished plan
     # 88
      ✓ should bind plan to req (8127ms)
    StartSubscription#GET
     # 89
      ✓ should present the form (7851ms)
     # 90
      ✓ should present the plan table (7744ms)
    StartSubscription#POST
     # 91
      ✓ should reject customer without card (6866ms)
     # 92
      ✓ should reject duplicate subscription (22172ms)
     # 93
      ✓ should apply after authorization (10413ms)

  /account/subscriptions/subscription
    Subscription#BEFORE
     # 94
      ✓ should reject invalid subscription (2115ms)
     # 95
      ✓ should reject other account's subscription (15475ms)
     # 96
      ✓ should bind subscription to req (16932ms)
    Subscription#GET
     # 97
      ✓ should present the subscription table (15244ms)

  /account/subscriptions/subscriptions
    Subscriptions#BEFORE
     # 98
      ✓ should bind subscriptions to req (26427ms)
    Subscriptions#GET
     # 99
      ✓ should enforce page size (45121ms)
     # 100
      ✓ should enforce specified offset (38654ms)

  /administrator/subscriptions/charge
    Charge#BEFORE
     # 101
      ✓ should reject invalid charge (4027ms)
     # 102
      ✓ should bind charge to req (15054ms)
    Charge#GET
     # 103
      ✓ should present the charge table (14289ms)

  /administrator/subscriptions/charges
    Charges#BEFORE
     # 104
      ✓ should bind charges to req (14786ms)
    Charges#GET
     # 105
      ✓ should enforce page size (58998ms)
     # 106
      ✓ should enforce specified offset (44352ms)

  /administrator/subscriptions/coupon
    Coupon#BEFORE
     # 107
      ✓ should reject invalid coupon (1942ms)
     # 108
      ✓ should bind coupon to req (2714ms)
    Coupon#GET
     # 109
      ✓ should present the coupon table (2716ms)

  /administrator/subscriptions/coupons
    Coupons#BEFORE
     # 110
      ✓ should bind coupons to req (2762ms)
    Coupons#GET
     # 111
      ✓ should enforce page size (5795ms)
     # 112
      ✓ should enforce specified offset (5506ms)

  /administrator/subscriptions/create-coupon
    CreateCoupon#GET
     # 113
      ✓ should present the form (1897ms)
    CreateCoupon#POST
     # 114
      ✓ should reject missing couponid (1693ms)
     # 115
      ✓ should enforce couponid length (1704ms)
     # 116
      ✓ should reject duplicate couponid (2476ms)
     # 117
      ✓ should reject missing duration (1720ms)
     # 118
      ✓ should enforce invalid duration (1687ms)
     # 119
      ✓ should require valid amount off (1689ms)
     # 120
      ✓ should require valid percent off (1719ms)
     # 121
      ✓ should require valid max redemptions (1754ms)
     # 122
      ✓ should require amount or percent off (1688ms)
     # 123
      ✓ should require valid duration in months if repeating (1687ms)
     # 124
      ✓ should require valid expires if provided (1686ms)
     # 125
      ✓ should create after authorization (2813ms)

  /administrator/subscriptions/create-plan
    CreatePlan#GET
     # 126
      ✓ should present the form (1664ms)
    CreatePlan#POST
     # 127
      ✓ should reject missing planid (1671ms)
     # 128
      ✓ should enforce planid length (2745ms)
     # 129
      ✓ should reject missing productid (1634ms)
     # 130
      ✓ should reject never published product (3009ms)
     # 131
      ✓ should reject unpublished product (4275ms)
     # 132
      ✓ should reject missing currency (2780ms)
     # 133
      ✓ should reject invalid currency (2800ms)
     # 134
      ✓ should reject missing amount (2866ms)
     # 135
      ✓ should reject invalid amount (2749ms)
     # 136
      ✓ should reject missing interval (2795ms)
     # 137
      ✓ should reject invalid interval (2999ms)
     # 138
      ✓ should reject invalid interval_count (2825ms)
     # 139
      ✓ should reject invalid trial_period_days (3137ms)
     # 140
      ✓ should create after authorization (4199ms)

  /administrator/subscriptions/create-product
    CreateProduct#GET
     # 141
      ✓ should present the form (1613ms)
    CreateProduct#POST
     # 142
      ✓ should reject missing name (1617ms)
     # 143
      ✓ should enforce name length (1635ms)
     # 144
      ✓ should reject missing statement_descriptor (1628ms)
     # 145
      ✓ should create after authorization (2417ms)

  /administrator/subscriptions/customer
    Customer#BEFORE
     # 146
      ✓ should reject invalid customer (3922ms)
     # 147
      ✓ should bind customer to req (3920ms)
    Customer#GET
     # 148
      ✓ should present the customer table (4082ms)

  /administrator/subscriptions/customers
    Customers#BEFORE
     # 149
      ✓ should bind customers to req (6342ms)
    Customers#GET
     # 150
      ✓ should enforce page size (10583ms)
     # 151
      ✓ should enforce specified offset (10282ms)

  /administrator/subscriptions/delete-coupon
    DeleteCoupon#BEFORE
     # 152
      ✓ should reject invalid couponid (2036ms)
     # 153
      ✓ should bind coupon to req (3023ms)
    DeleteCoupon#GET
     # 154
      ✓ should present the form (3321ms)
     # 155
      ✓ should present the coupon table (2918ms)
    DeleteCoupon#POST
     # 156
      ✓ should apply after authorization (4536ms)

  /administrator/subscriptions/delete-plan
    DeletePlan#BEFORE
     # 157
      ✓ should reject invalid planid (2015ms)
     # 158
      ✓ should bind plan to req (4619ms)
    DeletePlan#GET
     # 159
      ✓ should present the form (4695ms)
     # 160
      ✓ should present the plan table (4373ms)
    DeletePlan#POST
     # 161
      ✓ should apply after authorization (6290ms)

  /administrator/subscriptions/delete-product
    DeleteProduct#BEFORE
     # 162
      ✓ should reject invalid productid (1995ms)
     # 163
      ✓ should bind product to req (2717ms)
    DeleteProduct#GET
     # 164
      ✓ should present the form (2747ms)
     # 165
      ✓ should present the product table (2738ms)
    DeleteProduct#POST
     # 166
      ✓ should apply after authorization (4236ms)

  /administrator/subscriptions/delete-subscription
    DeleteSubscription#BEFORE
     # 167
      ✓ should reject invalid subscriptionid (1943ms)
     # 168
      ✓ should bind subscription to req (13796ms)
    DeleteSubscription#GET
     # 169
      ✓ should present the form (13403ms)
     # 170
      ✓ should present the subscription table (15697ms)
    DeleteSubscription#POST
     # 171
      ✓ should apply after authorization (15021ms)

  /administrator/subscriptions/edit-plan
    EditPlan#BEFORE
     # 172
      ✓ should reject invalid planid (2072ms)
     # 173
      ✓ should reject unpublished plan (5441ms)
     # 174
      ✓ should bind plan to req (4575ms)
    EditPlan#GET
     # 175
      ✓ should present the form (4907ms)
    EditPlan#POST
     # 176
      ✓ should reject missing productid (4648ms)
     # 177
      ✓ should reject never published product (6241ms)
     # 178
      ✓ should reject unpublished product (7419ms)
     # 179
      ✓ should reject invalid trial period (5751ms)
     # 180
      ✓ should update after authorization (7525ms)

  /administrator/subscriptions/edit-product
    EditProduct#BEFORE
     # 181
      ✓ should reject invalid productid (2038ms)
     # 182
      ✓ should reject unpublished product (4229ms)
     # 183
      ✓ should bind product to req (3000ms)
    EditProduct#GET
     # 184
      ✓ should present the form (2888ms)
    EditProduct#POST
     # 185
      ✓ should reject missing name (2713ms)
     # 186
      ✓ should enforce name length (2774ms)
     # 187
      ✓ should reject missing statement_descriptor (2759ms)
     # 188
      ✓ should reject invalid unit_label (2833ms)
     # 189
      ✓ should update after authorization (4214ms)

  /administrator/subscriptions/flag-charge
    FlagCharge#BEFORE
     # 190
      ✓ should reject invalid chargeid (2141ms)
     # 191
      ✓ should reject unrefunded charge (15247ms)
     # 192
      ✓ should bind charge to req (19145ms)
    FlagCharge#GET
     # 193
      ✓ should present the form (18509ms)
     # 194
      ✓ should present the charge table (22186ms)
    FlagCharge#POST
     # 195
      ✓ should apply after authorization (20568ms)

  /administrator/subscriptions/forgive-invoice
    ForgiveInvoice#BEFORE
     # 196
      ✓ should reject invalid invoiceid (1994ms)
     # 197
      ✓ should reject paid invoice (14469ms)
     # 198
      ✓ should reject forgiven invoice (26327ms)
     # 199
      2) should bind invoice to req
    ForgiveInvoice#GET
     # 200
      3) should present the form
     # 201
      4) should present the invoice table
    ForgiveInvoice#POST
     # 202
      5) should apply after authorization

  /administrator/subscriptions
    Index#BEFORE
     # 203
      ✓ should bind plans to req (4325ms)
     # 204
      ✓ should bind subscriptions to req (13160ms)
     # 205
      ✓ should bind coupons to req (2714ms)
    Index#GET
     # 206
      ✓ should have row for each plan (6030ms)
     # 207
      ✓ should have row for each coupon (3872ms)
     # 208
      ✓ should have row for each subscription (24970ms)

  /administrator/subscriptions/invoice
    Invoice#BEFORE
     # 209
      ✓ should reject invalid invoiceid (2022ms)
     # 210
      ✓ should bind invoice to req (17486ms)
    Invoice#GET
     # 211
      ✓ should present the invoice table (14045ms)

  /administrator/subscriptions/invoices
    Invoices#BEFORE
     # 212
      ✓ should bind invoices to req (28535ms)
    Invoices#GET
     # 213
      ✓ should enforce page size (44012ms)
     # 214
      ✓ should enforce specified offset (54280ms)

  /administrator/subscriptions/payout
    Payout#BEFORE
     # 215
      ✓ should bind reject invalid payoutid (1916ms)
     # 216
      6) should bind payout to req
    Payout#GET
     # 217
